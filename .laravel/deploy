#!/usr/bin/env bash

# Exit on error
set -e

echo "🚀 Starting deployment..."

# Ensure storage directories exist and are writable
echo "📁 Setting up storage directories..."
mkdir -p storage/framework/cache/data
mkdir -p storage/framework/sessions
mkdir -p storage/framework/views
mkdir -p storage/logs
mkdir -p storage/.laravel/cache

# Create .laravel directory and symlink cache to storage
mkdir -p .laravel
rm -rf .laravel/cache
ln -sf ../storage/.laravel/cache .laravel/cache

chmod -R 775 storage bootstrap/cache

# Install npm dependencies
echo "📦 Installing npm dependencies..."
npm ci

# Build frontend assets
echo "🏗️  Building frontend assets..."
npm run build

# Run migrations
echo "🗄️  Running migrations..."
php artisan migrate --force

# Clear and cache config
echo "⚙️  Optimizing application..."
php artisan config:cache
php artisan route:cache
php artisan view:cache

echo "✅ Deployment completed successfully!"
